<!DOCTYPE html>
<html lang="en-us" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='试试就逝世   bushi)'><title>模拟搭建企业自动化运维体系</title>

<link rel='canonical' href='https://kira-pgr.github.io/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/'>

<link rel="stylesheet" href="/scss/style.min.ac77dcf8b111b51da39a92990f431923f210f3876d85798a2125667f96dc33a4.css"><meta property='og:title' content='模拟搭建企业自动化运维体系'>
<meta property='og:description' content='试试就逝世   bushi)'>
<meta property='og:url' content='https://kira-pgr.github.io/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/'>
<meta property='og:site_name' content='猫猫の博客'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2022-07-07T17:20:00&#43;08:00'/><meta property='article:modified_time' content='2022-07-07T17:20:00&#43;08:00'/><meta property='og:image' content='https://kira-pgr.github.io/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/cover.jpg' />
<meta name="twitter:title" content="模拟搭建企业自动化运维体系">
<meta name="twitter:description" content="试试就逝世   bushi)"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://kira-pgr.github.io/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/cover.jpg' />
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu6303347a79895c67737217ae3756b054_237429_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">猫猫の博客</a></h1>
            <h2 class="site-description">DEV OPS SEC</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com/Kira-Pgr'
                        target="_blank"
                        title="GitHub"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        

        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        

        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        
        

        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        

        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        

        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>Dark Mode</span>
                </li>
            
        </div>
    </ol>
</aside>
<main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/">
                <img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/cover_hu4ba822080187716f522aa24ca87917bf_1033765_800x0_resize_q75_box.jpg"
                        srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/cover_hu4ba822080187716f522aa24ca87917bf_1033765_800x0_resize_q75_box.jpg 800w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/cover_hu4ba822080187716f522aa24ca87917bf_1033765_1600x0_resize_q75_box.jpg 1600w"
                        width="800" 
                        height="528" 
                        loading="lazy"
                        alt="Featured image of post 模拟搭建企业自动化运维体系" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/linux/" style="background-color: #98bbd0; color: #fff;">
                Linux
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/">模拟搭建企业自动化运维体系</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            试试就逝世   bushi)
        </h3>
        
    </div>

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jul 07, 2022</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    8 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>
</header>

    <section class="article-content">
    
    
    <h1 id="nanosec--模拟企业网络搭建">NanoSec&ndash;模拟企业网络搭建</h1>
<h2 id="part-1--规划">Part 1&ndash;规划</h2>
<p>由于实验条件限制，共准备5台机器来测试:</p>
<ol>
<li>
<p>Jenkins</p>
</li>
<li>
<p>GitLab + NFS</p>
</li>
<li>
<p>Database</p>
</li>
<li>
<p>Web Servers</p>
</li>
<li>
<p>Nginx_Reverse_Proxy</p>
</li>
</ol>
<blockquote>
<p>其中机器3,4,5中服务均用Docker进行部署，且用Jenkins进行自动化安装Docker环境, 启动并配置容器;)</p>
</blockquote>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/TP.jpg"
	width="1012"
	height="476"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/TP_hubab0974a764934cc7ba9659f7a9b4b63_20240_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/TP_hubab0974a764934cc7ba9659f7a9b4b63_20240_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="一个画的很狗的拓扑图"
	
	
		class="gallery-image" 
		data-flex-grow="212"
		data-flex-basis="510px"
	
></p>
<p>最后实现效果预测:访问Nginx反向代理可以访问到真实Web服务器的页面，Web服务器能正常访问数据库，代码以及部分配置文件使用GitLab储存，数据定时备份到备份服务器</p>
<h2 id="part-2--实验过程">Part 2&ndash;实验过程</h2>
<blockquote>
<p>本实验使用系统均为CentOS和Rocky Linux(新一代的CenOS ?)</p>
</blockquote>
<h3 id="准备工作">准备工作</h3>
<p>首先配置好5台机器的IP</p>
<blockquote>
<p>Jenkins                   192.168.245.137</p>
<p>GitLab+NFS           192.168.245.129</p>
<p>WebServers           192.168.245.149</p>
<p>DataBase               192.168.245.150</p>
<p>Nginx反向代理      192.168.245.151</p>
</blockquote>
<h4 id="gitlab安装">GitLab安装</h4>
<p>由于直接配置GitLab时我本地各种报错姿势(</p>
<p>就采用Docker配置了，其实Docker配置反倒方便一些= =</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-docker" data-lang="docker"><span class="line"><span class="cl">sudo docker run --detach <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --hostname IP or Domain <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --env <span class="nv">GITLAB_OMNIBUS_CONFIG</span><span class="o">=</span><span class="s2">&#34;external_url &#39;http://IP or Domain/&#39;; gitlab_rails[&#39;lfs_enabled&#39;] = true;&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --publish 443:443 --publish 80:80 --publish 2222:22 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --name gitlab <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --restart always <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --volume <span class="nv">$GITLAB_HOME</span>/config:/etc/gitlab <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --volume <span class="nv">$GITLAB_HOME</span>/logs:/var/log/gitlab <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --volume <span class="nv">$GITLAB_HOME</span>/data:/var/opt/gitlab <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --shm-size 256m <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  gitlab/gitlab-ee:latest<span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>然后就直接在浏览器访问该机器IP并按照提示配置，这里不再过多赘述</p>
<p>至于使用方法嘛。。。和<del>世界上最大的同性交友平台</del>GitHub差不多</p>
<h4 id="jenkins安装">Jenkins安装</h4>
<p>由于Jenkins依赖Java环境，先安装Java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">yum -y install java-11-openjdk
</span></span></code></pre></td></tr></table>
</div>
</div><p>接下来导入Jenkins官方源</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo
</span></span></code></pre></td></tr></table>
</div>
</div><p>导入Jenkins密钥</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key
</span></span></code></pre></td></tr></table>
</div>
</div><p>终于可以安装啦uwu</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">yum install jenkins
</span></span></code></pre></td></tr></table>
</div>
</div><p>安装完之后可不要忘记启动并启用服务哦 ;D</p>
<blockquote>
<p>P.S. 启动服务:使服务立刻运行起来，启用服务:使服务开机自启</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">systemctl start jenkins
</span></span><span class="line"><span class="cl">systemctl <span class="nb">enable</span> jenkins
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后即可在<code>ip:8080</code>访问Jenkins了喵</p>
<h4 id="jenkins配置">Jenkins配置</h4>
<p>在自定义Jenkins那步选择<strong>安装推荐的插件</strong>，这样你之后可以少很多折腾</p>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/Plug.jpg"
	width="789"
	height="465"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/Plug_hu6786ceea50aca37089148a0e4284c76b_26705_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/Plug_hu6786ceea50aca37089148a0e4284c76b_26705_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="169"
		data-flex-basis="407px"
	
></p>
<p>然后就是安装其他配置自动化需要的插件(Ansible, SSH)了</p>
<p>去到<code>http://ip:8080/pluginManager/</code>(即<code>Manage Jenkins</code>下的<code>Plugin Manager</code>)</p>
<p>然后在<code>Available</code>一栏搜索SSH和Jenkins</p>
<blockquote>
<p>一个小提醒:SSH插件存在已知漏洞，从<strong>安全角度考虑生产环境请慎用</strong>(指可以找到这些漏洞的临时缓解方案)，在实验里我偷个小懒</p>
</blockquote>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/4.jpg"
	width="1375"
	height="674"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/4_hu8814786f0602457dd08f41b6a29edb65_61296_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/4_hu8814786f0602457dd08f41b6a29edb65_61296_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="步骤如图"
	
	
		class="gallery-image" 
		data-flex-grow="204"
		data-flex-basis="489px"
	
></p>
<p>要是想要节省时间，选中两个插件之后选择<code>Install without restart</code></p>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/5.jpg"
	width="725"
	height="427"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/5_hu3fb8a0995a3bed5059ca92fe507ca7c7_23206_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/5_hu3fb8a0995a3bed5059ca92fe507ca7c7_23206_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="直接上图吧= ="
	
	
		class="gallery-image" 
		data-flex-grow="169"
		data-flex-basis="407px"
	
></p>
<p>安装完成之后该配置各个插件了uwu</p>
<h5 id="ssh">SSH</h5>
<p>去到<code>http://ip:8080/configure</code>或在网页点击<code>Manage Jenkins</code> &ndash;&gt;<code>Configure System</code></p>
<p>在这一界面下滑直到看到<code>SSH remote hosts</code></p>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/6.jpg"
	width="439"
	height="134"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/6_hu4cf2abb05ac5d7dd5144943631646021_4848_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/6_hu4cf2abb05ac5d7dd5144943631646021_4848_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="327"
		data-flex-basis="786px"
	
></p>
<p>然后点击下方的<code>Add</code>进行配置</p>
<ul>
<li>
<p><code>Hostname</code>:主机名，一般填写目标主机ip(写一个)</p>
</li>
<li>
<p><code>Port</code>：ssh端口，默认22</p>
</li>
<li>
<p><code>Credentials</code>：认证信息，即为通过ssh远程连接目标主机的用户名、密码</p>
</li>
</ul>
<hr>
<p>这里注意，如果是第一次使用，需要添加新的认证信息</p>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/7.jpg"
	width="483"
	height="185"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/7_hudca93671f7d3466b8db333519b2c3971_15723_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/7_hudca93671f7d3466b8db333519b2c3971_15723_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="还等什么??点Add呀!"
	
	
		class="gallery-image" 
		data-flex-grow="261"
		data-flex-basis="626px"
	
></p>
<p>如果你想使用用户名，密码来认证的化，选择<code>Username with password</code>,然后填好你的用户名，密码</p>
<blockquote>
<p>注意，你要用自动化配置的几台机器的账号密码须一样</p>
</blockquote>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/8.jpg"
	width="1410"
	height="602"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/8_hu8892530fb1f52586b7dc745b4b55a6a4_36418_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/8_hu8892530fb1f52586b7dc745b4b55a6a4_36418_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="234"
		data-flex-basis="562px"
	
></p>
<hr>
<p>然后点下方的<code>check connection</code>检查连接,如果看到提示<code>Successfull connection</code>即为连接成功，然后点击<code>Apply</code>- -&gt;<code>Save</code>即可完成ssh配置</p>
<h5 id="ansible">Ansible</h5>
<p>如果要使用Ansible插件，你必须机器(注意是装有Jenkins的机器)上安装有Ansible</p>
<blockquote>
<p>Tip:Ansible是一个批量自动化管理多台机器的工具</p>
</blockquote>
<p>Ansible在epel源里才有，所以先安装epel源</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">yum -y install epel-release
</span></span></code></pre></td></tr></table>
</div>
</div><p>安装Ansible</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">yum -y install ansible
</span></span></code></pre></td></tr></table>
</div>
</div><p>下面配置Ansible插件</p>
<p>去到<code>http://ip:8080/configureTools/</code>，或者网页上<code>Manage Jenkins</code> - -&gt; <code>Global Tool Configuration</code></p>
<p>下划到<code>Ansible</code>区域，点击<code>Add Ansible</code></p>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/9.jpg"
	width="389"
	height="191"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/9_hu131514d8c0f82ef766da13f19e39aaed_7498_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/9_hu131514d8c0f82ef766da13f19e39aaed_7498_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="203"
		data-flex-basis="488px"
	
></p>
<p>分别添加<code>ansible</code>和<code>ansible-playbook</code>,默认他们的路径都安装在<code>/usr/bin</code>下，如果不放心可以用<code>which</code>命令检查</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">which ansible
</span></span><span class="line"><span class="cl">which ansible-playbook
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>注意这里的安装路径写到可执行文件所在目录</p>
<p>比如说我的ansible是<code>/usr/bin/ansible</code>,我只需要填<code>/usr/bin</code></p>
</blockquote>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/10-1.jpg"
	width="1300"
	height="481"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/10-1_hu791da616eeee3fb3755db2ec17c8c564_21963_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/10-1_hu791da616eeee3fb3755db2ec17c8c564_21963_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="ansible"
	
	
		class="gallery-image" 
		data-flex-grow="270"
		data-flex-basis="648px"
	
></p>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/10-2.jpg"
	width="1300"
	height="482"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/10-2_hu3a8bc55f34ceeb089bb4c09a4681f7e2_24025_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/10-2_hu3a8bc55f34ceeb089bb4c09a4681f7e2_24025_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="ansible-playbook"
	
	
		class="gallery-image" 
		data-flex-grow="269"
		data-flex-basis="647px"
	
></p>
<hr>
<p>Ansible有个小坑，就是它不会说&quot;是&quot;</p>
<p>为什么这么说捏</p>
<p>因为当SSH询问是否需要将新的主机添加到<code>known_hosts</code>时Ansible无法回应,那就只有报错辣;(</p>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/17.jpg"
	width="1394"
	height="528"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/17_hu9a6a7a35b55e21213a89272e0177d619_77850_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/17_hu9a6a7a35b55e21213a89272e0177d619_77850_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="呜呜呜，Ansible好可怜  雾)"
	
	
		class="gallery-image" 
		data-flex-grow="264"
		data-flex-basis="633px"
	
></p>
<p>嘛= =那就帮帮Ansible吧，让它省去烦人的说&quot;是&quot;的步骤</p>
<p>在装有<code>Jenkins</code>和<code>Ansible</code>的机器上完成:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">vi /etc/ssh/ssh_config
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后将<code>/etc/ssh/ssh_config</code> 内容中的<code>StrictHostKeyChecking</code> 值为<code>no</code> ,让机器自动接受证书</p>
<blockquote>
<p>注意去掉这一行前的注释符<code>#</code></p>
</blockquote>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/18.jpg"
	width="1494"
	height="807"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/18_hu880132dc73536d7a0effdb0f42b30610_121846_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/18_hu880132dc73536d7a0effdb0f42b30610_121846_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="有图有真相"
	
	
		class="gallery-image" 
		data-flex-grow="185"
		data-flex-basis="444px"
	
></p>
<p>别忘了关键的重启一步喵~~</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">systemctl restart sshd
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h4 id="nfs安装和配置">NFS安装和配置</h4>
<h5 id="安装">安装</h5>
<p>由于<code>rpc-bind</code>是NFS的依赖项，必须先安装</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">dnf -y install rpcbind nfs-utils
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后启动<code>rpc-blind</code>和NFS服务(<code>rpc-bind</code>服务一定先启动)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">systemctl start rpcbind
</span></span><span class="line"><span class="cl">systemctl start nfs-server
</span></span><span class="line"><span class="cl">systemctl <span class="nb">enable</span> rpcbind
</span></span><span class="line"><span class="cl">systemctl <span class="nb">enable</span> nfs-server
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="配置">配置</h5>
<p>由于我们的NFS是用来备份数据库的，所以建一个名为DB_Backup的备份文件夹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mkdir /DB_Backup
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后修改配置文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">vi /etc/exports
</span></span></code></pre></td></tr></table>
</div>
</div><p>输入如下内容:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">/DB_Backup 192.168.245.1/24<span class="o">(</span>sync,ro<span class="o">)</span> 192.168.245.150<span class="o">(</span>sync,rw,no_root_squash<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>至于配置文件里里东西的含义，可以看下文</p>
<ul>
<li>
<p>最前面的是用来存放备份文件的目录绝对路径</p>
</li>
<li>
<p>地址可以使用完整IP或网段，例如10.0.0.8或10.0.0.0/24，10.0.0.0/255.255.255.0当然也可以地址可以使用主机名，DNS解析的和本地/etc/hosts解析的都行，支持通配符，例如：*.nanosec.site</p>
</li>
<li>
<p>关于括号里的权限设置</p>
<ul>
<li>
<p>rw：read-write，可读写;</p>
</li>
<li>
<p>ro：read-only，只读;</p>
</li>
<li>
<p>sync：文件同时写入硬盘和内存;</p>
</li>
<li>
<p>async：文件暂存于内存，而不是直接写入硬盘;</p>
</li>
<li>
<p>no_root_squash：NFS客户端连接服务端时如果使用的是root的话，那么对服务端分享的目录来说，也拥有root权限;</p>
</li>
<li>
<p>root_squash：NFS客户端连接服务端时如果使用的是root的话，那么对服务端分享的目录来说，拥有匿名用户权限，通常他将使用nobody或nfsnobody身份;</p>
</li>
<li>
<p>all_squash：不论NFS客户端连接服务端时使用什么用户，对服务端分享的目录来说都是拥有匿名用户权限;</p>
</li>
<li>
<p>anonuid：匿名用户的UID值，通常是nobody或nfsnobody，可以在此处自行设定;</p>
</li>
<li>
<p>anongid：匿名用户的GID值</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>出于安全角度角度，只给192.168.245.150即存放数据库的机器写权限</p>
<p>当然，no_root_squash参数最好也不要使用</p>
</blockquote>
<p>编辑配置文件完成后，需要运行<code>exportfs</code>重新发布所共享的目录</p>
<p>当然也可以重启服务，不过记得先重启<code>rpcbind</code></p>
<h3 id="实现自动化安装环境">实现自动化安装环境</h3>
<p>我们梳理一下思路，我们现在大概可以想到两种方案</p>
<h4 id="方案猜想">方案猜想</h4>
<p>第一种就是直接用SSH插件:不断添加构建步骤在不同机器上进行安装</p>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/11.jpg"
	width="594"
	height="499"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/11_hu79e4e35ad266e6b3590d55d3124e14af_34682_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/11_hu79e4e35ad266e6b3590d55d3124e14af_34682_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="119"
		data-flex-basis="285px"
	
></p>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/12.jpg"
	width="1247"
	height="587"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/12_hu9c044ff48b5ef396f50e31a1223e7a00_28393_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/12_hu9c044ff48b5ef396f50e31a1223e7a00_28393_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="不得不说，是不是又那么亿点烦"
	
	
		class="gallery-image" 
		data-flex-grow="212"
		data-flex-basis="509px"
	
></p>
<p>这个方法想想是没什么问题，但绝对不是适合我们这种懒人的哒= =</p>
<p>因为一旦设备数足够多，工作量就会巨大，费时费力</p>
<p>第二种方法则是通过ansible插件结合Jenkins和ansible来完成批量自动化，用一个构建步骤就可以在n台机器上运行脚本，而我们只需要提供运行的命令和所有机器的ip就好了</p>
<p><del>绝对是效率贼高的偷懒摸鱼小妙招</del></p>
<h4 id="开始施工awa">开始施工awa</h4>
<p>ok,现在我们想好了方案，接下来要做的就是新建一个Jenkins项目然后进行配置</p>
<p>回到<code>Dashboard</code>- -&gt;<code>New item</code>新建一个项目</p>
<p>给项目起一个合适的名字(比如说用来安装环境的项目叫做Install),然后选<code>Freestyle Project</code>,然后再<del>傻瓜式地</del>点OK</p>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/13.jpg"
	width="1492"
	height="764"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/13_hu9266081d2cb53e48ec37aa9eb8acbed6_101372_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/13_hu9266081d2cb53e48ec37aa9eb8acbed6_101372_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="你是不是还在想项目叫什么(?"
	
	
		class="gallery-image" 
		data-flex-grow="195"
		data-flex-basis="468px"
	
></p>
<p>然后<code>Add build step</code>-&gt;<code>Invoke Ansible Ad-Hoc Command(调用Ansible临时命令)</code></p>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/14.jpg"
	width="602"
	height="496"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/14_hu540c502a602a414f9b0bd01281d8b574_32599_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/14_hu540c502a602a414f9b0bd01281d8b574_32599_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="如图"
	
	
		class="gallery-image" 
		data-flex-grow="121"
		data-flex-basis="291px"
	
></p>
<p>接下来这样填空</p>
<ul>
<li>
<p><code>Ansible installation</code>&ndash;&gt;<code>ansible</code></p>
</li>
<li>
<p><code>Host pattern</code>填<strong>all</strong></p>
</li>
<li>
<p><code>Inventory</code>-&gt;<code>Inline content</code></p>
</li>
</ul>
<blockquote>
<p>P.S.如果你不需要使用编程语言来生成IP列表,</p>
<p>请不要勾选下方的<code>Dynamic inventory</code></p>
</blockquote>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/15-1.jpg"
	width="1266"
	height="612"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/15-1_hu57e93bda8b45dddce357893423f532af_34127_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/15-1_hu57e93bda8b45dddce357893423f532af_34127_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="呐呐呐~~"
	
	
		class="gallery-image" 
		data-flex-grow="206"
		data-flex-basis="496px"
	
></p>
<ul>
<li><code>Content</code>填你需要执行命令机器的IP,一行一个</li>
<li><code>Module</code>填<code>shell</code></li>
<li><code>Module arguments or command to execute</code>填你要执行的命令,我们这里是要为3台机器配置Docker运行环境</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">yum install -y yum-utils
</span></span><span class="line"><span class="cl">yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
</span></span><span class="line"><span class="cl">yum install -y docker-ce docker-ce-cli --allowerasing
</span></span><span class="line"><span class="cl">systemctl start docker
</span></span><span class="line"><span class="cl">systemctl <span class="nb">enable</span> docker
</span></span><span class="line"><span class="cl">docker pull centos
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/15-2.jpg"
	width="1258"
	height="640"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/15-2_hu991cec24529d5374f803afdd72465c57_44167_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/15-2_hu991cec24529d5374f803afdd72465c57_44167_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="图是不能少的啦qwq"
	
	
		class="gallery-image" 
		data-flex-grow="196"
		data-flex-basis="471px"
	
></p>
<ul>
<li><code>Credentials</code>选我们前面在配置SSH插件的适合创建的那个</li>
<li>其他的东西保持默认</li>
</ul>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/15-3.jpg"
	width="1260"
	height="531"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/15-3_huaf66fc5de6486a9c57a3f299b0ac405f_19975_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/15-3_huaf66fc5de6486a9c57a3f299b0ac405f_19975_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="237"
		data-flex-basis="569px"
	
></p>
<p>然后就是<code>Apply</code>+<code>Save</code>一把梭= =</p>
<p>然后回到项目主界面之后捏，点<code>Build Now</code></p>
<p>就是那个上面有绿绿三角形的钟~~(要是你理解为其他的东西也可以~~</p>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/16.jpg"
	width="1919"
	height="561"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/16_hu5757ccf8d7feba82c148037cff4d9cee_45305_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/16_hu5757ccf8d7feba82c148037cff4d9cee_45305_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="没事，反正有图"
	
	
		class="gallery-image" 
		data-flex-grow="342"
		data-flex-basis="820px"
	
></p>
<p>要是你运气好，没报错，就能看到一个绿绿的勾</p>
<img title="" src="PASS.jpg" alt="嘛= = 长这样" width="331">
<p>要是BUG满天飞，就会是一个红红火火的x</p>
<img title="" src="FAIL.jpg" alt="祝愿大家永远没BUG" width="331">
<p>假设现在已经运行成功并且没有任何报错，右键<code>build</code>编号，点<code>Console Output</code>查看控制台输出</p>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/19.jpg"
	width="1917"
	height="745"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/19_huaf9989b892971d1933dd01cf0c58dbd0_104310_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/19_huaf9989b892971d1933dd01cf0c58dbd0_104310_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="OK！完工qaq"
	
	
		class="gallery-image" 
		data-flex-grow="257"
		data-flex-basis="617px"
	
></p>
<p>到现在为止，我们3台机器上已经安装好了Docker环境并拉去了centos镜像</p>
<h3 id="部署web-server">部署Web Server</h3>
<blockquote>
<p>我的内心是崩溃的，Docker对于我这种菜狗就全都是坑 =  =</p>
</blockquote>
<h4 id="思路">思路</h4>
<p>我这边的实验能是打算用Docker搭一个LNMP架构，再安装WordPress,</p>
<p>当然啦，用Docker也可以搭建其他网站架构</p>
<h4 id="jenkins新建一个新项目">Jenkins新建一个新项目</h4>
<p>建项目的流程和上面配置自动化安装基本一样，就是把机器ip和代码替换掉就可以了</p>
<h4 id="lnmp">LNMP</h4>
<p>在这个过程中真的踩到无数的坑，可能是因为Docker这个镜像精简的<code>feature</code>吧，很多最最基础的东西都没有= =</p>
<p>不管怎么说，先启动Docker,再映射到一个<del>吉利的</del>端口  <del>(顿时接地气了起来，咳咳= =</del></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker run --name LNMP -p 8888:80 -d -t centos:latest
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>至于为什么不直接pull nginx的镜像，是因为想统一用yum包管理器，而nginx镜像是apt包管理器= =</p>
</blockquote>
<h5 id="第一个坑容器无法正常启动">第一个坑:容器无法正常启动</h5>
<p>你会注意到上面启动容器的命令里包含了<code>-t</code>参数，</p>
<p>为什么咧????</p>
<p>&ndash; 因为不加上centos镜像启动的容器会立刻停止运行</p>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/20.jpg"
	width="1175"
	height="133"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/20_hu179365e207b53619013dedb83625c086_34439_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/20_hu179365e207b53619013dedb83625c086_34439_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="就是这么狗"
	
	
		class="gallery-image" 
		data-flex-grow="883"
		data-flex-basis="2120px"
	
></p>
<h5 id="第二个坑无法使用yum源">第二个坑:无法使用Yum源</h5>
<p>太狗了!  容器里的yum源用不了= =</p>
<p>报错如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Failed to <span class="nb">set</span> locale, defaulting to C.UTF-8
</span></span><span class="line"><span class="cl">CentOS Linux <span class="m">8</span> - AppStream                                                                                                   <span class="m">57</span>  B/s <span class="p">|</span>  <span class="m">38</span>  B     00:00
</span></span><span class="line"><span class="cl">Error: Failed to download metadata <span class="k">for</span> repo <span class="s1">&#39;appstream&#39;</span>: Cannot prepare internal mirrorlist: No URLs in mirrorlist
</span></span></code></pre></td></tr></table>
</div>
</div><p>看到这个报错，我直接炸毛= =</p>
<p>刚开始还以为源的URL没有加上，后来发现是因为<code>AppStream</code>的<code>mirrorlist</code>里URL用不了</p>
<p>在<code>/etc/yum.repos.d/CentOS-Linux-AppStream.repo</code>文件中官方友情提醒了我们</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># If the mirrorlist does not work for you, you can try the commented out
</span></span><span class="line"><span class="cl"># baseurl line instead.
</span></span></code></pre></td></tr></table>
</div>
</div><p>所以我们只需要把<code>mirrorlist</code>那一行注释掉并且取消<code>baseurl</code>的注释</p>
<p>因为我们是在Jenkins里自动化，很显然不能用vim,就改用下面这种方法</p>
<blockquote>
<p>注意:自动化也导致不能<code>docker exec -ti 容器名 /bin/bash</code>调出交互终端</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker <span class="nb">exec</span> -it LNMP sh -c <span class="s2">&#34;sed -i &#39;s/mirrorlist/#mirrorlist/g&#39; /etc/yum.repos.d/CentOS-*&#34;</span>
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP sh -c <span class="s2">&#34;sed -i &#39;s|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g&#39; /etc/yum.repos.d/CentOS-*&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>P.S. 使用<code>sh -c &quot;内容&quot;</code>的原因是不放在引号里<code>Docker exec</code>会把后面一团东东当成两条命令执行</p>
</blockquote>
<h5 id="第三个坑systemctl报错">第三个坑:systemctl报错</h5>
<p>在一番快乐的安装之后</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP yum makecache
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP yum -y install nginx
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP yum -y install php*
</span></span></code></pre></td></tr></table>
</div>
</div><p>该到了启动和启用服务的时候了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP systemctl start php-fpm
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP systemctl <span class="nb">enable</span> php-fpm
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP systemctl start nginx
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP systemctl <span class="nb">enable</span> nginx
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后&quot;啪!&ldquo;就是一个报错</p>
<p>好家伙! systemctl都用不了!!!   震怒)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">System has not been booted with systemd as init system <span class="o">(</span>PID 1<span class="o">)</span>. Can<span class="err">&#39;</span>t operate.
</span></span><span class="line"><span class="cl">Failed to connect to bus: Host is down
</span></span></code></pre></td></tr></table>
</div>
</div><img title="" src="nu.jpg" alt="" width="143" data-align="center">
<p>还好有<del>GayHub</del>GitHub上大佬的<a class="link" href="https://github.com/gdraheim/docker-systemctl-replacement"  target="_blank" rel="noopener"
    >Docker systemctl替代品</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP yum -y install wget
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP yum -y install python3
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP sh -c <span class="s2">&#34;wget https://raw.githubusercontent.com/gdraheim/docker-systemctl-replacement/master/files/docker/systemctl3.py -O /usr/local/bin/systemctl&#34;</span>
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP sh -c <span class="s2">&#34;chmod +x /usr/local/bin/systemctl&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>小提醒:GitHub的raw应该是被gfw给挡住了，所以可能要给Docker配置代理</p>
</blockquote>
<h4 id="部署wordpress">部署WordPress</h4>
<p>因为我们要从GitHub拉取Wordpress源码(或者从内部的GitLab拉取代码)</p>
<p>先给容器安装Git</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP yum -y install git
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后再把原先nginx默认的一些网页文件删除</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP sh -c <span class="s2">&#34;rm -rf /usr/share/nginx/html/*&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>拉取WordPress</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP sh -c <span class="s2">&#34;git clone https://github.com/WordPress/WordPress.git /usr/share/nginx/html/&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后就可以访问机器ip开始安装WordPress啦</p>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/WP.jpg"
	width="1918"
	height="840"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/WP_huc7c72e8510fe0cca76662c03e31eec7a_89735_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/WP_huc7c72e8510fe0cca76662c03e31eec7a_89735_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="228"
		data-flex-basis="548px"
	
></p>
<h5 id="又双叒叕踩坑啦wordpress权限不足">又双叒叕踩坑啦:WordPress权限不足</h5>
<p>你需要在Jenkins中提前让WordPress目录对于所有用户可写</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP sh -c <span class="s2">&#34;chmod -R 777 /usr/share/nginx/html/&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>否则就不能自动化了qeq</p>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/21.jpg"
	width="1142"
	height="663"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/21_hua744ec4f04003630f7219a1ffd4fbc75_44064_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/21_hua744ec4f04003630f7219a1ffd4fbc75_44064_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="我不想接受这个抱歉"
	
	
		class="gallery-image" 
		data-flex-grow="172"
		data-flex-basis="413px"
	
></p>
<p>输入已经配置好的数据库信息</p>
<blockquote>
<p>数据库配置见下文</p>
</blockquote>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/wp2.jpg"
	width="1109"
	height="615"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/wp2_hub528b98807145f4e17ccbcf21cca4816_51426_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/wp2_hub528b98807145f4e17ccbcf21cca4816_51426_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="180"
		data-flex-basis="432px"
	
></p>
<h4 id="自动化花里胡哨">自动化花里胡哨</h4>
<p>嘿嘿，最后给配个<a class="link" href="https://github.com/mashirozx/sakura"  target="_blank" rel="noopener"
    >主题</a>，让我的实验kawaii起来~~</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP sh -c <span class="s2">&#34;git clone https://github.com/mashirozx/sakura.git /usr/share/nginx/html/wp-content/themes/Sakura/&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/theme.jpg"
	width="809"
	height="536"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/theme_hu486b38f6208f54dffe23747ffdf76669_48395_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/theme_hu486b38f6208f54dffe23747ffdf76669_48395_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="主题预览"
	
	
		class="gallery-image" 
		data-flex-grow="150"
		data-flex-basis="362px"
	
></p>
<h4 id="附上代码">附上代码</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker run --name LNMP -p 8888:80 -d -t centos:latest
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -it LNMP sh -c <span class="s2">&#34;sed -i &#39;s/mirrorlist/#mirrorlist/g&#39; /etc/yum.repos.d/CentOS-*&#34;</span>
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP sh -c <span class="s2">&#34;sed -i &#39;s|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g&#39; /etc/yum.repos.d/CentOS-*&#34;</span>
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP yum makecache
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP yum -y install nginx
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP yum -y install php*
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP yum -y install wget
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP yum -y install python3
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP yum -y install git
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP sh -c <span class="s2">&#34;wget https://raw.githubusercontent.com/gdraheim/docker-systemctl-replacement/master/files/docker/systemctl3.py -O /usr/local/bin/systemctl&#34;</span>
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP sh -c <span class="s2">&#34;chmod +x /usr/local/bin/systemctl&#34;</span>
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP systemctl start php-fpm
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP systemctl <span class="nb">enable</span> php-fpm
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP systemctl start nginx
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP systemctl <span class="nb">enable</span> nginx
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP sh -c <span class="s2">&#34;rm -rf /usr/share/nginx/html/*&#34;</span>
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP sh -c <span class="s2">&#34;git clone https://github.com/WordPress/WordPress.git /usr/share/nginx/html/&#34;</span>
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP sh -c <span class="s2">&#34;chmod -R 777 /usr/share/nginx/html/&#34;</span>
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti LNMP sh -c <span class="s2">&#34;git clone https://github.com/mashirozx/sakura.git /usr/share/nginx/html/wp-content/themes/Sakura/&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="部署mariadb数据库">部署MariaDB数据库</h3>
<h4 id="老规矩jenkins新建项目">老规矩:Jenkins新建项目</h4>
<p>不过有了前面的经验之后，这边可以偷个小懒，嘿嘿嘿</p>
<p>细心的朋友们可以发现，在新建项目的时候还可以用之前的项目作为模版</p>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/22.jpg"
	width="1422"
	height="408"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/22_hu2744b412728c5e618591b07eb0ab3231_24477_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/22_hu2744b412728c5e618591b07eb0ab3231_24477_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="好诶，可以懒了"
	
	
		class="gallery-image" 
		data-flex-grow="348"
		data-flex-basis="836px"
	
></p>
<p>我们就以刚刚配置的Web Server作为模板</p>
<p>点OK创建之后你会看见和一个和Web Server项目配置相同的新项目</p>
<p>接下来也是老样子:修改IP和代码</p>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/25.jpg"
	width="1238"
	height="778"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/25_huc12be82f3810cf7a0a8de7518439ea5b_79997_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/25_huc12be82f3810cf7a0a8de7518439ea5b_79997_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="159"
		data-flex-basis="381px"
	
></p>
<h4 id="配置数据库">配置数据库</h4>
<p>现在在之前配置Web Server的代码基础上进行修改</p>
<blockquote>
<p>P.S.:建议把容器名进行修改，并起一个易于识别的名字</p>
</blockquote>
<h5 id="3306端口">3306端口</h5>
<p>既然是MariaDB数据库(和MySQL基本相同)，那就需要映射3306到端口</p>
<p>为了之后备份的方便，我们映射一个目录<code>/mnt/backup</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mkdir /mnt/backup
</span></span><span class="line"><span class="cl">docker run --name MySQL -p 3306:3306 -d -t -v /mnt/backup:/mnt/backup centos:latest
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="关于安装">关于安装</h5>
<p>这里轻松多啦，我们已经解决了前面所提及的几个大坑，</p>
<p>仔细思考，因为在这里只需要部署数据库，前面安装PHP和Nginx的代码可以干掉啦qwq</p>
<blockquote>
<p><strong>注意：记得保留前面解决坑所需的代码= =</strong></p>
</blockquote>
<p>然后换成安装MariaDB的代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti MySQL yum -y install mariadb mariadb-server
</span></span></code></pre></td></tr></table>
</div>
</div><p>启动并启用数据库服务</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti MySQL systemctl start mariadb
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti MySQL systemctl <span class="nb">enable</span> mariadb
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="配置-1">配置</h5>
<p>因为我们是自动化，所以不能用之前一贯的方法调出MariaDB的交互式控制台</p>
<p>那么，就直接在命令行执行SQL语句吧</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mysql -u 用户名 -p密码 -e <span class="s2">&#34;语句&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意初始状态的MariaDB是没有密码的，</p>
<p>毕竟我们是网安人嘛，为了安全性肯定要设置密码= =</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti MySQL mysql -e <span class="s2">&#34;ALTER USER &#39;root&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;你的密码&#39;;&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>因为需要让跑Web Server的那台机器访问到数据库，我们进行配置一下权限，顺便再建一个叫做DB的数据库(以存放WordPress的数据)</p>
<p>为了安全性，我们只许可Web Server的机器用root的用户名和密码登陆</p>
<blockquote>
<p>注意这里指mysql的root用户，和系统的root用户不一样哦 -   -</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti MySQL mysql -u root -p123.密码 -e <span class="s2">&#34;use mysql; GRANT ALL PRIVILEGES ON *.* TO &#39;root&#39;@&#39;ip&#39;IDENTIFIED BY &#39;密码&#39; WITH GRANT OPTION; flush privileges; create database db;&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="备份">备份</h4>
<p>好啦，最后要做的就是定时备份数据库</p>
<p>毕竟数据无价是真理嘛awa</p>
<p>首先给数据库的主机装个NFS客户端并每次启动时挂载共享文件夹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">yum -y install nfs-utils
</span></span><span class="line"><span class="cl">mount.nfs IP:/DB_Backup /mnt/backup/
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s1">&#39;mount.nfs IP:/DB_Backup /mnt/backup/&#39;</span> &gt;&gt; /etc/rc.local
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s1">&#39;docker start MySQL&#39;</span> &gt;&gt; /etc/rc.local
</span></span><span class="line"><span class="cl">chmod +x /etc/rc.local
</span></span></code></pre></td></tr></table>
</div>
</div><p>现在来到容器内部完成真正定时&quot;备份&quot;的操作</p>
<p>我们决定每天备份一次数据库，这个时候小小偷个懒，不用<code>crontab -e</code>了，直接将脚本放到<code>/etc/cron.daily</code></p>
<p>我们可以把备份的脚本放在GitLab里</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>mysqldump -u root -p密码 --all-databases &gt; /db/data-dump.sql
</span></span><span class="line"><span class="cl"><span class="nv">date</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span>date +%F<span class="k">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">cp /db/data-dump.sql /mnt/backup/DB_<span class="nv">$date</span>
</span></span><span class="line"><span class="cl">rm -rf /db/data-dump.sql
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/23.jpg"
	width="1912"
	height="842"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/23_hub48237f653917c1a3ce43a6776273b2d_90308_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/23_hub48237f653917c1a3ce43a6776273b2d_90308_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="放在GitLab会更方便管理"
	
	
		class="gallery-image" 
		data-flex-grow="227"
		data-flex-basis="544px"
	
></p>
<p>由于我们脚本里需要用到<code>/db</code>目录，我们得先建</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti MySQL sh -c <span class="s2">&#34;mkdir /db&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后就<code>git pull</code>到<code>/etc/cron.daily</code>目录并赋予适当权限(记得先在容器里安装git哦)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti MySQL yum -y install git
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti MySQL sh -c <span class="s2">&#34;git clone http://IP/nanosec/backup.git /etc/cron.daily/&#34;</span>
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti MySQL sh -c <span class="s2">&#34;chmod +x /etc/cron.daily/backup.sh&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后可以先运行一下看看是否备份成功</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti MySQL sh -c <span class="s2">&#34;/etc/cron.daily/backup.sh&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/26.jpg"
	width="999"
	height="663"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/26_hu838e2f8ad07977a755d634f3ae5287e5_71929_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/26_hu838e2f8ad07977a755d634f3ae5287e5_71929_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="150"
		data-flex-basis="361px"
	
></p>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/24.jpg"
	width="441"
	height="96"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/24_hu4fe1442baff7bd7c951c5ce5fabb5310_8435_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/24_hu4fe1442baff7bd7c951c5ce5fabb5310_8435_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="成功XD"
	
	
		class="gallery-image" 
		data-flex-grow="459"
		data-flex-basis="1102px"
	
></p>
<h4 id="附上代码-1">附上代码</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mkdir /mnt/backup
</span></span><span class="line"><span class="cl">yum -y install nfs-utils
</span></span><span class="line"><span class="cl">mount.nfs 192.168.245.129:/DB_Backup /mnt/backup/
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s1">&#39;mount.nfs 192.168.245.129:/DB_Backup /mnt/backup/&#39;</span> &gt;&gt; /etc/rc.local
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s1">&#39;docker start MySQL&#39;</span> &gt;&gt; /etc/rc.local
</span></span><span class="line"><span class="cl">chmod +x /etc/rc.local
</span></span><span class="line"><span class="cl">docker run --name MySQL -p 3306:3306 -d -t -v /mnt/backup:/mnt/backup centos:latest
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -it MySQL sh -c <span class="s2">&#34;sed -i &#39;s/mirrorlist/#mirrorlist/g&#39; /etc/yum.repos.d/CentOS-*&#34;</span>
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti MySQL sh -c <span class="s2">&#34;sed -i &#39;s|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g&#39; /etc/yum.repos.d/CentOS-*&#34;</span>
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti MySQL yum makecache
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti MySQL yum -y install mariadb mariadb-server
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti MySQL yum -y install wget
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti MySQL yum -y install python3
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti MySQL yum -y install git
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti MySQL sh -c <span class="s2">&#34;wget https://raw.githubusercontent.com/gdraheim/docker-systemctl-replacement/master/files/docker/systemctl3.py -O /usr/local/bin/systemctl&#34;</span>
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti MySQL sh -c <span class="s2">&#34;chmod +x /usr/local/bin/systemctl&#34;</span>
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti MySQL systemctl start mariadb
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti MySQL systemctl <span class="nb">enable</span> mariadb
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti MySQL mysql -e <span class="s2">&#34;ALTER USER &#39;root&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;密码&#39;;&#34;</span>
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti MySQL mysql -u root -p密码 -e <span class="s2">&#34;use mysql; GRANT ALL PRIVILEGES ON *.* TO &#39;root&#39;@&#39;IP&#39;IDENTIFIED BY &#39;密码&#39; WITH GRANT OPTION; flush privileges; create database db;&#34;</span>
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti MySQL sh -c <span class="s2">&#34;mkdir /db&#34;</span>
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti MySQL sh -c <span class="s2">&#34;git clone http://192.168.245.129/nanosec/backup.git /etc/cron.daily/&#34;</span>
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti MySQL sh -c <span class="s2">&#34;chmod +x /etc/cron.daily/backup.sh&#34;</span>
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti MySQL sh -c <span class="s2">&#34;/etc/cron.daily/backup.sh&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="配置nginx反向代理">配置Nginx反向代理</h3>
<p>呼，最后的工作则是配置Nginx反向代理</p>
<p><del>(心里:aaaaaaa总算熬到头了)</del></p>
<h4 id="jenkins项目">Jenkins项目</h4>
<p>到这里应该已经成为&quot;老油条&quot;了，</p>
<p>直接利用模板+修改一把梭</p>
<img src="awa.jpg" title="" alt="" width="60">
<p>最后大概确定应该肯定是这样纸捏</p>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/27.jpg"
	width="1245"
	height="772"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/27_hu836adf1d51f47e292a0038b6982634eb_58051_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/27_hu836adf1d51f47e292a0038b6982634eb_58051_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="161"
		data-flex-basis="387px"
	
></p>
<h4 id="部署nginx反向代理">部署Nginx反向代理</h4>
<p>为了用户访问方便，这次直接映射到80端口</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker run --name N_Proxy -p 80:80 -d -t centos:latest
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="安装-1">安装</h5>
<p>Nginx反代嘛= =</p>
<p>当然就是要装Nginx</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti N_Proxy yum -y install nginx
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后就是日常对服务的操作</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti N_Proxy systemctl start nginx
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti N_Proxy systemctl <span class="nb">enable</span> nginx
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="配置-2">配置</h5>
<p>老样子，先把默认的网站文件删除</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti N_Proxy sh -c <span class="s2">&#34;rm -rf /usr/share/nginx/html/*&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后就到了最关键一步，配置文件的调整</p>
<p>为了之后修改配置文件能够<del>优雅地</del>偷懒，我们将配置文件托管在GitLab上</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user nginx<span class="p">;</span>
</span></span><span class="line"><span class="cl">worker_processes auto<span class="p">;</span>
</span></span><span class="line"><span class="cl">error_log /var/log/nginx/error.log<span class="p">;</span>
</span></span><span class="line"><span class="cl">pid /run/nginx.pid<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Load dynamic modules. See /usr/share/doc/nginx/README.dynamic.</span>
</span></span><span class="line"><span class="cl">include /usr/share/nginx/modules/*.conf<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">events <span class="o">{</span>
</span></span><span class="line"><span class="cl">    worker_connections 1024<span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">http <span class="o">{</span>
</span></span><span class="line"><span class="cl">    log_format  main  <span class="s1">&#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; &#39;</span>
</span></span><span class="line"><span class="cl">                      <span class="s1">&#39;$status $body_bytes_sent &#34;$http_referer&#34; &#39;</span>
</span></span><span class="line"><span class="cl">                      <span class="s1">&#39;&#34;$http_user_agent&#34; &#34;$http_x_forwarded_for&#34;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    access_log  /var/log/nginx/access.log  main<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    sendfile            on<span class="p">;</span>
</span></span><span class="line"><span class="cl">    tcp_nopush          on<span class="p">;</span>
</span></span><span class="line"><span class="cl">    tcp_nodelay         on<span class="p">;</span>
</span></span><span class="line"><span class="cl">    keepalive_timeout   65<span class="p">;</span>
</span></span><span class="line"><span class="cl">    types_hash_max_size 2048<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    include             /etc/nginx/mime.types<span class="p">;</span>
</span></span><span class="line"><span class="cl">    default_type        application/octet-stream<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Load modular configuration files from the /etc/nginx/conf.d directory.</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># See http://nginx.org/en/docs/ngx_core_module.html#include</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># for more information.</span>
</span></span><span class="line"><span class="cl">    include /etc/nginx/conf.d/*.conf<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">#include /etc/nginx/default.d/*.conf;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">upstream web1 <span class="o">{</span>
</span></span><span class="line"><span class="cl">        server 192.168.245.149:8888  <span class="nv">weight</span><span class="o">=</span>1<span class="p">;</span>        <span class="c1">#此处填写被代理服务器IP</span>
</span></span><span class="line"><span class="cl">       <span class="c1">#server 192.168.0.17  weight=1;</span>
</span></span><span class="line"><span class="cl">       <span class="c1">#ip_hash;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">server<span class="o">{</span>
</span></span><span class="line"><span class="cl">        listen 80<span class="p">;</span>
</span></span><span class="line"><span class="cl">        server_name blog.nanosec.io<span class="p">;</span>
</span></span><span class="line"><span class="cl">        access_log  /var/log/nginx/blog.log<span class="p">;</span>
</span></span><span class="line"><span class="cl">        location / <span class="o">{</span>
</span></span><span class="line"><span class="cl">            root /home/web1_root<span class="p">;</span>
</span></span><span class="line"><span class="cl">            proxy_pass http://web1<span class="p">;</span>
</span></span><span class="line"><span class="cl">            proxy_read_timeout 300<span class="p">;</span>
</span></span><span class="line"><span class="cl">            proxy_connect_timeout 300<span class="p">;</span>
</span></span><span class="line"><span class="cl">            proxy_redirect     off<span class="p">;</span>
</span></span><span class="line"><span class="cl">            proxy_set_header   X-Forwarded-Proto <span class="nv">$scheme</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            proxy_set_header   Host              <span class="nv">$http_host</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            proxy_set_header   X-Real-IP         <span class="nv">$remote_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/28.jpg"
	width="1585"
	height="620"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/28_hua4ae1027bbaeba33f0064f18c54fef7e_50243_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/28_hua4ae1027bbaeba33f0064f18c54fef7e_50243_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="配图"
	
	
		class="gallery-image" 
		data-flex-grow="255"
		data-flex-basis="613px"
	
>我们先把原有的配置文件干掉</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti N_Proxy sh -c <span class="s2">&#34;rm -rf /etc/nginx/nginx.conf&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后再放上新的配置文件</p>
<blockquote>
<p>注意：因为<code>git clone</code>无法clone进一个已经存在的目录</p>
<p>所以我们需要先clone到一个其他位置并进行移动</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti N_Proxy sh -c <span class="s2">&#34;git clone http://192.168.245.129/nanosec/your-code-here.git&#34;</span>
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti N_Proxy sh -c <span class="s2">&#34;cp /your-code-here/nginx.conf /etc/nginx/&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>检查配置文件是否存在问题</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti N_Proxy nginx -t
</span></span></code></pre></td></tr></table>
</div>
</div><p>检查无误后再重新加载配置文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker <span class="nb">exec</span> -ti N_Proxy nginx -s reload
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="完工">完工</h4>
<p>这个时候就可以让这个项目跑起来啦awa</p>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/30.jpg"
	width="1059"
	height="675"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/30_hufca6db4e98f81389b0873d5504c95ec7_105467_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/30_hufca6db4e98f81389b0873d5504c95ec7_105467_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="好诶!没有报错"
	
	
		class="gallery-image" 
		data-flex-grow="156"
		data-flex-basis="376px"
	
></p>
<p>到这里我们访问反向代理的ip或者把<code>blog.nanosec.io</code>解析到这个ip后访问就可以看到Web Server的那个网页啦</p>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/29.jpg"
	width="937"
	height="80"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/29_hueb5b90525fb4cf606e51d6c59824a990_6539_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/29_hueb5b90525fb4cf606e51d6c59824a990_6539_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="1171"
		data-flex-basis="2811px"
	
></p>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/wp3.jpg"
	width="1919"
	height="841"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/wp3_hu247aef0cba82f0843aca389463206524_80693_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/wp3_hu247aef0cba82f0843aca389463206524_80693_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="TaDa! 美滋滋~~"
	
	
		class="gallery-image" 
		data-flex-grow="228"
		data-flex-basis="547px"
	
></p>
<h2 id="part3--结语">Part3&ndash;结语</h2>
<p>Hmmm,这样一个有意思的自动化企业网络架构部署到这里就完成了</p>
<h3 id="优势">优势</h3>
<p>可以说是为运维带来了很大的便捷，一旦机器多起来一台一台装显得费时费力又不现实，</p>
<p>自动化通过按几个键就能完成部署，在很大程度上提高了效率 = =</p>
<p><img src="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/233.jpg"
	width="1918"
	height="811"
	srcset="/p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/233_hu1c39254c82a3387047299d017b409ba6_134470_480x0_resize_q75_box.jpg 480w, /p/%E6%A8%A1%E6%8B%9F%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB/233_hu1c39254c82a3387047299d017b409ba6_134470_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="你说方便不方便;)"
	
	
		class="gallery-image" 
		data-flex-grow="236"
		data-flex-basis="567px"
	
></p>
<p>以后的维护也是变得特别简单了</p>
<ul>
<li>要是代码和配置文件需要更改直接去GitLab改</li>
<li>要是一些配置步骤需要微调直接在Jenkins上操作</li>
<li>新加入的机器只需要按几个键就可以完成部署</li>
</ul>
<h3 id="一些思考">一些思考</h3>
<h4 id="关于本方案如何改进">关于本方案如何改进</h4>
<ul>
<li>使用ZStack私有云，在与Docker共度了几个夜晚之后，我发现如果在<strong>拥有足够的性能</strong>条件下，还是使用虚拟机比较好，至于原因嘛，一是对于新手来说友好，配置/使用更加方便，二是安全性更高，毕竟虚拟机逃逸比容器逃逸要困难</li>
</ul>
<blockquote>
<p>本次实验由于性能问题，没带动ZStack(悲</p>
</blockquote>
<ul>
<li>可以把Jenkins里配置的命令集合成脚本，并也托管到GitLab上，这样后期维护会更加便捷</li>
<li>备份最好独立一台机器，并把GitLab和Jenkins里的东西也做相应备份</li>
</ul>
<h4 id="关于安全的思考">关于安全的思考</h4>
<p>怎么说呢。。。这种事情就把所有机器的权限高度集中在一个地方了，这实际上在某种意义上也是十分危险的= =</p>
<p>因为一旦集中权限的机器被入侵，那就是&quot;全都没了&quot;的惨剧了</p>
<blockquote>
<p>就举个最简单的例子，Jenkins机器放到了公网上，而且还是弱密码= =</p>
</blockquote>
<img src="cx.jpg" title="" alt="" width="117">
<p>当然，从攻击者的角度，可以考虑对于权限集中的地方下手;)</p>
<h2 id="part-4----ref">Part 4 &ndash; Ref</h2>
<p><a class="link" href="http://book.fsec.io/"  target="_blank" rel="noopener"
    >http://book.fsec.io/</a></p>

</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/kali-gnome%E6%A1%8C%E9%9D%A2%E7%8E%AF%E5%A2%83%E3%81%AE%E8%B0%83%E6%95%B4%E7%BE%8E%E5%8C%96/">
        
        
            <div class="article-image">
                <img src="/p/kali-gnome%E6%A1%8C%E9%9D%A2%E7%8E%AF%E5%A2%83%E3%81%AE%E8%B0%83%E6%95%B4%E7%BE%8E%E5%8C%96/cover.f2cd6cd2cf6d28cce9f098425b362967_hu81a9c413a1c8e188446087e0ced1bda4_3605489_250x150_fill_q75_box_smart1.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Kali Gnome桌面环境の调整&amp;美化"
                        
                        data-hash="md5-8s1s0s9tKMzp8JhCWzYpZw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Kali Gnome桌面环境の调整&amp;美化</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/debian-linux%E4%B8%8B%E5%AE%89%E8%A3%85%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%BD%AF%E4%BB%B6/">
        
        
            <div class="article-image">
                <img src="/p/debian-linux%E4%B8%8B%E5%AE%89%E8%A3%85%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%BD%AF%E4%BB%B6/cover.324a51e9dbf43598476ed25b88c6f485_hu5a0bff5542c2b4a2a99ba03dfc469cdd_192581_250x150_fill_q75_box_smart1.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Debian Linux下安装虚拟机软件"
                        
                        data-hash="md5-MkpR6dv0NZhHbtJbiMb0hQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Debian Linux下安装虚拟机软件</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <div id="gitalk-container"></div>
<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"
/>
<script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.18.0/js/md5.min.js"></script>
<script>
    const gitalk = new Gitalk({
        clientID: "350f7151191770b41225",
        clientSecret: "dfc2d6ff148e57ac47c9efedb4ddf9c370fc33f0",
        repo: "kira-pgr.github.io",
        owner: "Kira-Pgr",
        admin: ["Kira-Pgr"],
        distractionFreeMode: false, 
        id: md5(location.pathname), 
    });
    (function () {
        if (
            ["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1
        ) {
            document.getElementById("gitalk-container").innerHTML =
                "Gitalk comments not available by default when the website is previewed locally.";
            return;
        }
        gitalk.render("gitalk-container");
    })();
</script>



    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2022 猫猫の博客
    </section>
    
    <section class="powerby">
        
            For a better open source community! <br/>
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.13.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#part-1--规划">Part 1&ndash;规划</a></li>
    <li><a href="#part-2--实验过程">Part 2&ndash;实验过程</a>
      <ol>
        <li><a href="#准备工作">准备工作</a>
          <ol>
            <li><a href="#gitlab安装">GitLab安装</a></li>
            <li><a href="#jenkins安装">Jenkins安装</a></li>
            <li><a href="#jenkins配置">Jenkins配置</a>
              <ol>
                <li><a href="#ssh">SSH</a></li>
                <li><a href="#ansible">Ansible</a></li>
              </ol>
            </li>
            <li><a href="#nfs安装和配置">NFS安装和配置</a>
              <ol>
                <li><a href="#安装">安装</a></li>
                <li><a href="#配置">配置</a></li>
              </ol>
            </li>
          </ol>
        </li>
        <li><a href="#实现自动化安装环境">实现自动化安装环境</a>
          <ol>
            <li><a href="#方案猜想">方案猜想</a></li>
            <li><a href="#开始施工awa">开始施工awa</a></li>
          </ol>
        </li>
        <li><a href="#部署web-server">部署Web Server</a>
          <ol>
            <li><a href="#思路">思路</a></li>
            <li><a href="#jenkins新建一个新项目">Jenkins新建一个新项目</a></li>
            <li><a href="#lnmp">LNMP</a>
              <ol>
                <li><a href="#第一个坑容器无法正常启动">第一个坑:容器无法正常启动</a></li>
                <li><a href="#第二个坑无法使用yum源">第二个坑:无法使用Yum源</a></li>
                <li><a href="#第三个坑systemctl报错">第三个坑:systemctl报错</a></li>
              </ol>
            </li>
            <li><a href="#部署wordpress">部署WordPress</a>
              <ol>
                <li><a href="#又双叒叕踩坑啦wordpress权限不足">又双叒叕踩坑啦:WordPress权限不足</a></li>
              </ol>
            </li>
            <li><a href="#自动化花里胡哨">自动化花里胡哨</a></li>
            <li><a href="#附上代码">附上代码</a></li>
          </ol>
        </li>
        <li><a href="#部署mariadb数据库">部署MariaDB数据库</a>
          <ol>
            <li><a href="#老规矩jenkins新建项目">老规矩:Jenkins新建项目</a></li>
            <li><a href="#配置数据库">配置数据库</a>
              <ol>
                <li><a href="#3306端口">3306端口</a></li>
                <li><a href="#关于安装">关于安装</a></li>
                <li><a href="#配置-1">配置</a></li>
              </ol>
            </li>
            <li><a href="#备份">备份</a></li>
            <li><a href="#附上代码-1">附上代码</a></li>
          </ol>
        </li>
        <li><a href="#配置nginx反向代理">配置Nginx反向代理</a>
          <ol>
            <li><a href="#jenkins项目">Jenkins项目</a></li>
            <li><a href="#部署nginx反向代理">部署Nginx反向代理</a>
              <ol>
                <li><a href="#安装-1">安装</a></li>
                <li><a href="#配置-2">配置</a></li>
              </ol>
            </li>
            <li><a href="#完工">完工</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#part3--结语">Part3&ndash;结语</a>
      <ol>
        <li><a href="#优势">优势</a></li>
        <li><a href="#一些思考">一些思考</a>
          <ol>
            <li><a href="#关于本方案如何改进">关于本方案如何改进</a></li>
            <li><a href="#关于安全的思考">关于安全的思考</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#part-4----ref">Part 4 &ndash; Ref</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>
<script src="/js/snow.js"></script>
<script
    src="https://cdn.jsdelivr.net/gh/zhixuan2333/gh-blog@v0.1.0/js/ribbon.min.js"
    integrity="sha384-UEK8ZiP3VgFNP8KnKMKDmd4pAUAOJ59Y2Jo3ED2Z5qKQf6HLHovMxq7Beb9CLPUe"
    crossorigin="anonymous"
    size="300"
    alpha="0.6"
    zindex="-1"
    defer
></script>

    </body>
</html>
